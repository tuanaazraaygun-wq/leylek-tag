<analysis>
<original_problem_statement>
The initial task was a complete UI/UX refactor of the passenger and driver offer cards to achieve a more premium, Uber-like feel. The user provided a detailed design brief. However, during testing of a previous implementation, a critical bug emerged: drivers would send offers, but they would never reach the passenger.

After extensive debugging, the root cause was identified as a flawed socket connection lifecycle on the frontend. The  hook was creating new, non-persistent connections within different components, causing the driver's socket to disconnect before the  event could be successfully emitted to the server.

The user has explicitly approved a new plan: a major refactor to implement a **singleton socket architecture using a React Context ()**. This will create one global, persistent socket connection at the application's root level, decoupling the socket's lifecycle from any individual component's lifecycle. This is the current and only priority.
</original_problem_statement>

**User's preferred language**: Turkish. The next agent MUST respond in Turkish.

**what currently exists?**
The application is a full-stack Expo (React Native) and FastAPI project. The backend uses a custom Python Socket.IO server () on a VPS for all real-time communication.

The frontend is currently in a broken state due to the socket lifecycle issue. The agent has begun the approved refactor by creating a new file: . The rest of the frontend code (, ) still uses the old, flawed approach where socket connections are tied to component lifecycles.

**Last working item**:
    - Last item agent was working: The agent started a major refactoring of the socket connection management. The goal is to create a single, persistent, global socket instance using a React Context Provider () to fix the critical bug where  events were not reaching the server. The agent had just created the new context file .
    - Status: **IN PROGRESS**
    - Agent Testing Done: N
    - Which testing method agent to use? After the refactor is complete, the agent must test the core offer flow end-to-end. This involves checking server logs ( on the VPS) to confirm  is received and  is emitted. Then, an APK build must be provided to the user for final verification.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - **Issue 1: CRITICAL BUG - Driver offers do not reach the passenger (P0)**
    - **Description:** When a driver sends an offer, the  event is not received by the socket server. Server logs show the driver connects, receives the , but then either disconnects or fails to emit the  event. Debug endpoints confirmed  remains 0.
    - **Attempted fixes:**
        - Relaxing  validation in .
        - Ensuring  is passed in all relevant payloads (, ).
        - Attempting to create a pseudo-global socket instance within . These fixes failed because they did not address the root cause.
    - **Root Cause:** The socket connection lifecycle is tied to React component lifecycles. When a component (e.g., the offer card modal) unmounts, the socket connection is lost.
    - **Next debug checklist:** This is now an implementation task, not a debug task. The  refactor must be completed.
    - **Why fix this issue and what will be achieved with the fix?** This bug breaks the application's primary function. Fixing it will make the ride-hailing system operational.
    - **Status:** **IN PROGRESS** (Fix is being implemented via the  refactor).
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Both. Backend logs are essential for verification, and the frontend flow must be tested by the user.

**In progress Task List**:
  - **Task 1: Complete the Singleton Socket Refactor using  (P0)**
     - **Where to resume:**
         1. Edit  to wrap the root  or  component with the newly created . This will instantiate the socket at the app's entry point.
         2. Heavily refactor . It should no longer create its own connection (). Instead, it should use the  hook to access the single socket instance provided by . The hook will now only be responsible for returning the socket instance and memoized  functions.
         3. Ensure all components that use  (primarily ) function correctly with the refactored hook, without any changes to their own logic.
     - **What will be achieved with this?** A stable, persistent socket connection that is independent of component mount/unmount cycles, which will fix the critical  bug.
     - **Status:** IN PROGRESS
     - **Should Test frontend/backend/both after fix?** Both.
     - **Blocked on something:** None.

**Upcoming and Future Tasks**
- **Upcoming Tasks (Blocked by P0 Bug):**
    - **P1:** Complete the UI/UX Refactor of the Offer Cards (Passenger & Driver). This was the original task before the critical bug was discovered. The goal is a premium, Uber/InDrive-like feel, as per the user's detailed brief.
    - **P1:** Implement the new Searching Phase UI for passengers: a persistent map at the top showing all offering drivers, and a scrollable list of offer cards below. This replaces the old full-screen Offers Received page.
- **Future Tasks (Low Priority):**
    - **P2:** Re-enable and Fix Sound Effects.
    - **P2:** Correctly Implement the Point System.
    - **P3:** Implement In-App Account Deletion (Apple Store requirement).

**Completed work in this session**
- Numerous failed attempts to fix the socket bug, which were crucial for correctly diagnosing the root cause (flawed lifecycle management).
- Deployed  v7.2 to the VPS, which includes better logging and ensures  is passed in the  event.
- Successfully identified and got user approval for the correct architectural solution: a  context.
- Created the initial file for the new architecture: .

**Earlier issues found/mentioned but not fixed**
- All other issues have been deprioritized in favor of fixing the P0 critical bug.

**Known issue recurrence from previous fork**
- None.

**Code Architecture**


**Key Technical Concepts**
- **Socket.IO:** Used for all real-time communication.
- **Singleton Pattern (via React Context):** The approved architecture to ensure a single, persistent socket connection.
- **Socket Lifecycle Management:** The core problem being solved. The socket's life must be tied to the application's life, not a component's.
- **Expo (React Native):** The frontend framework.
- **FastAPI:** The backend framework.

**key DB schema**
- No schema changes have occurred.  and  tables are still in use.

**All files of reference**
- : The new file for the socket provider.
- : Needs to be wrapped with the .
- : Needs a major refactor to consume the context.
- : The primary consumer of the  hook.

**Critical Info for New Agent**
1.  **Your ONLY Task:** Complete the  refactor. The user is frustrated with the recurring bug, and this is the agreed-upon, correct architectural fix. Do not get sidetracked.
2.  **Implementation Steps:**
    *   Wrap the application root in  with the  you will build in .
    *   Refactor  to get the socket instance from the context. It should **not** create a new connection.
    *   Verify that all  functions in  use the single, global socket instance.
3.  **Do NOT Repeat Mistakes:** Do not try to fix the bug by making small changes inside  or . The previous attempts failed. The only path forward is the full architectural refactor.
4.  **Verification is Key:** After the refactor, you must test the full flow and check the server logs on the VPS () to confirm that , , and  logs appear correctly.

**documents created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Msg 454):** Explicitly approves the  + singleton socket architecture and urges the agent to finish the job, acknowledging the high credit usage. **(This is the current mandate).**
2.  **User (Msg 452):** Asks the agent for a diagnosis and a plan to fix the recurring issue. **(Answered by agent in Msg 453).**
3.  **User (Msg 450):** Reports the fix failed again and asks for a complete explanation of the system to ask ChatGPT. **(Agent provided a detailed breakdown).**
4.  **User (Msg 446):** Asks for the APK. **(Completed).**
5.  **User (Msg 404):** Reports the fix failed again, expressing frustration and demanding a working solution. **(In Progress).**
6.  **User (Msg 400):** Asks if the build is finished. **(Completed).**
7.  **User (Msg 382):** Reports a new error (Talep bulunamadÄ±) after the previous fix. **(This led to the discovery of the missing  in the state).**
8.  **User (Msg 328):** Reports the offer is sending but never arrives after the global socket refactor attempt. **(In Progress).**
9.  **User (Msg 318):** Asks to be notified when the APK is ready. **(Completed).**
10. **User (Msg 285):** Provides a very clear, technical mandate to fix the driver socket lifecycle, demanding a persistent global socket and specific logging to be present. **(This is the core of the current task).**

**Project Health Check:**
- **Broken:** The core feature (sending/receiving offers) is non-functional due to the socket lifecycle bug.

**3rd Party Integrations**
- **Supabase:** PostgreSQL database.
- **Daily.co:** Voice/video calls.
- **Custom Socket.IO Server:** User-hosted VPS at  (v7.2).

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: []
- Known regressions: The entire offer system is currently broken.

**Credentials to test flow:**
- **Socket Server SSH:**
    - IP: 
    - User: 
    - Pass: 

**What agent forgot to execute**
- The agent has been repeatedly stuck on the same critical bug, trying incremental fixes instead of addressing the architectural flaw sooner. The current task is to finally implement the correct architecture that was identified and approved. All other feature work (like UI refactoring) has been correctly postponed.
</analysis>
